# PRD: PDFポッドキャスト出力サイズ70%削減機能

## 概要

現在のPDFポッドキャストシステムの音声出力ファイルサイズを30%（70%削減）に最適化する機能を実装する。

## 背景・課題

### 現状のサイズ問題
- 3.7分の音声で10〜12MBのファイルサイズ
- 実際のビットレート: 384kbps（WAVファイルとして生成後、拡張子のみMP3に変更）
- ステレオ出力への強制変換（320kbps設定）
- 過度に高品質な設定（24kHz、320kbps）

### 削減目標
- **目標**: 現在のサイズの30%（70%削減）
- **想定結果**: 10〜12MB → 3〜4MB

## 要件定義

### 機能要件

#### FR1: 音声ビットレート最適化
- **要求**: デフォルトビットレートを320kbpsから128kbpsに変更
- **理由**: ポッドキャスト音声には128kbpsで十分な品質
- **削減効果**: 約60%

#### FR2: 適切なMP3エンコーディング
- **要求**: WAV形式からの適切なMP3変換を実装
- **理由**: 現在は偽装されたWAVファイル（384kbps）
- **削減効果**: 約30%追加

#### FR3: サンプルレート最適化
- **要求**: サンプルレートを24kHzから22.05kHzに変更
- **理由**: 人間の音声帯域（〜11kHz）を適切にカバー
- **削減効果**: 約27%追加

#### FR4: モノラル出力維持
- **要求**: ステレオ強制変換を無効化、モノラル出力を維持
- **理由**: ポッドキャストはモノラルが一般的
- **削減効果**: 約50%（ステレオ化を防ぐ）

#### FR5: 設定カスタマイズ機能
- **要求**: ユーザーが音質設定を選択可能
- **オプション**:
  - `--quality high`: 現在の設定維持
  - `--quality standard`: 最適化設定（デフォルト）
  - `--quality compact`: より積極的な圧縮

### 非機能要件

#### NFR1: 音質維持
- **要求**: 音声内容の理解に支障がない品質を維持
- **基準**: 128kbps MP3、22.05kHz、モノラル

#### NFR2: 後方互換性
- **要求**: 既存のCLIオプション`--bitrate`との互換性を維持
- **対応**: 新しい`--quality`オプションと併用可能

#### NFR3: 処理速度
- **要求**: 音声生成速度の低下を最小限に抑制
- **基準**: 現在の処理時間の110%以内

## 技術仕様

### 実装対象ファイル

#### 1. `audio_mixer.py`
```python
# 変更予定箇所
DEFAULT_EXPORT_PARAMS = {
    "format": "mp3",
    "bitrate": "128k",  # 320k → 128k
    "parameters": ["-ac", "1"]  # "-ac", "2" → "-ac", "1"
}
```

#### 2. `tts_client.py`
```python
# 変更予定箇所
def _save_wav_file(self, filename: Path, pcm_data: bytes, 
                  channels: int = 1, rate: int = 22050,  # 24000 → 22050
                  sample_width: int = 2) -> None:
```

#### 3. `__main__.py`
```python
# 新規追加予定
parser.add_argument(
    "--quality",
    choices=["high", "standard", "compact"],
    default="standard",
    help="音声品質設定"
)
```

### 品質設定マッピング

| 設定 | ビットレート | サンプルレート | チャンネル | 想定サイズ削減 |
|------|-------------|---------------|-----------|---------------|
| high | 320kbps | 24kHz | ステレオ | 0%（現状維持） |
| standard | 128kbps | 22.05kHz | モノラル | 70% |
| compact | 96kbps | 16kHz | モノラル | 80% |

## 実装計画

### Phase 1: 基本最適化実装
1. AudioMixerのデフォルト設定変更
2. TTSClientのサンプルレート調整
3. モノラル出力設定の実装

### Phase 2: 設定オプション追加
1. `--quality`オプションの実装
2. 設定値のマッピング機能
3. 既存`--bitrate`との統合

### Phase 3: テスト・検証
1. 各品質設定でのサイズ測定
2. 音質検証
3. 処理速度ベンチマーク

## 成功指標

### 定量的指標
- **ファイルサイズ**: 70%削減達成
- **音質**: MOS（Mean Opinion Score）4.0以上維持
- **処理時間**: 現在の110%以内

### 定性的指標
- ユーザビリティの向上（設定選択の柔軟性）
- 既存機能との互換性維持

## リスク・制約

### リスク
- **音質劣化**: 過度な圧縮による理解度低下
- **互換性問題**: 既存の出力ファイルとの違い

### 制約
- Gemini TTS APIの出力フォーマット制限
- FFmpegの利用可能な圧縮オプション

## 承認・レビュー

このPRDの実装前に以下の確認が必要：

1. **音質要件の確認**: 128kbpsで十分な品質か
2. **ユーザー影響**: デフォルト変更の受け入れ可否
3. **技術的実現性**: 各コンポーネントの変更可能性

---

**作成日**: 2025/06/08  
**ステータス**: レビュー待ち  
**優先度**: 高