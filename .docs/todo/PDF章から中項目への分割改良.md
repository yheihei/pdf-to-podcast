# PRD: PDF章から中項目への分割改良

## 概要

現在のPDF-Podcastシステムは章レベル（第1章、第2章など）での音声ファイル生成を行っているが、章が大きすぎるため、より細かい中項目レベル（1.1、1.2など）での音声ファイル生成に改良する。

## 現在の実装状況の分析

### 現在の章抽出方法
- `PDFParser.extract_chapters()`: Gemini APIを使用してPDFから章構造を検出
- LLMプロンプトで「各章のタイトルとページ番号を抽出」を指示
- 目次優先、本文からの推測をフォールバック
- 出力: `[{"title": "第1章 はじめに", "start_page": 11, "end_page": 25}]`

### 現在の処理フロー
1. `PDFParser.extract_chapters()` → Chapter オブジェクトリスト
2. `ScriptBuilder.generate_scripts_async()` → 章ごとのスクリプト生成
3. `TTSClient.generate_chapter_audios_async()` → 章ごとの音声生成

## 要件定義

### 機能要件

#### FR1: 中項目レベルの構造抽出
- 1.1、1.2、2.1、2.2のような中項目レベルでPDF構造を抽出
- 序章、エピローグ、付録の中でも中項目があれば抽出
- 目次がある場合は優先的に使用、ない場合は本文から推測

#### FR2: 中項目データ構造の拡張
- 現在の`Chapter`クラスを拡張または新しいデータ構造を定義
- 階層構造（章 > 中項目）を表現できること
- 各中項目のタイトル、開始・終了ページ、テキストを保持

#### FR3: 中項目ごとのスクリプト生成
- 現在の章ごとのスクリプト生成を中項目レベルに変更
- 各中項目が独立した講義スクリプトとして生成される
- スクリプト長は1500-1800文字の制限を維持

#### FR4: 中項目ごとの音声生成
- 各中項目が独立した音声ファイルとして生成される
- ファイル名は中項目を識別可能な形式（例: `1_1_データ構造.mp3`）

#### FR5: 後方互換性の維持
- 中項目が検出されない場合は現在の章レベルで動作
- 既存のCLIオプションとの互換性を維持

### 非機能要件

#### NFR1: パフォーマンス
- 中項目数の増加によるAPI呼び出し増加を考慮
- レート制限の遵守（現在と同様）

#### NFR2: 品質
- 中項目レベルでも適切な講義品質を維持
- 中項目間の論理的つながりを考慮したスクリプト生成

#### NFR3: 運用性
- ログとマニフェストで中項目レベルの進捗追跡
- 中項目レベルでのスキップ・再実行機能

## 技術設計案

### 1. データ構造の拡張

```python
@dataclass
class Section:
    """中項目の情報を保持するデータクラス"""
    title: str
    section_number: str  # "1.1", "2.3" など
    start_page: int
    end_page: int
    text: str = ""
    parent_chapter: str = ""  # 所属する章のタイトル

@dataclass 
class Chapter:
    """章の情報を保持するデータクラス（拡張版）"""
    title: str
    start_page: int
    end_page: int
    text: str = ""
    sections: List[Section] = field(default_factory=list)
```

### 2. PDFParser の拡張

- `extract_chapters()` を `extract_sections()` に拡張
- LLMプロンプトを中項目抽出用に変更
- 階層構造を解析して Section + Chapter 構造を生成

### 3. ScriptBuilder の変更

- 入力を章単位から中項目単位に変更
- 中項目のコンテキスト（所属章、前後の中項目）を考慮したスクリプト生成

### 4. TTSClient の変更

- 中項目ごとの音声ファイル生成
- ファイル名規則の変更（章_中項目_タイトル.mp3）

### 5. Manifest の拡張

- 中項目レベルでの進捗管理
- 階層構造の表現

## 実装計画

### Phase 1: データ構造とPDFParser拡張
1. Section クラスの定義
2. Chapter クラスの sections フィールド追加
3. PDFParser.extract_sections() 実装
4. LLMプロンプトの中項目抽出対応

### Phase 2: ScriptBuilder対応
1. 中項目単位でのスクリプト生成対応
2. 中項目コンテキストを考慮したプロンプト調整

### Phase 3: TTSClient対応
1. 中項目ごとの音声ファイル生成
2. ファイル命名規則の変更

### Phase 4: Manifest・ログ対応
1. Manifest の中項目対応
2. ログとプログレス表示の中項目対応

### Phase 5: 統合テスト・後方互換性確保
1. 既存テストの更新
2. 中項目が検出されない場合のフォールバック実装
3. エンドツーエンドテスト

## 成功指標

1. 中項目レベルでの音声ファイル生成が正常に動作する
2. 中項目が検出されないPDFでも従来通り動作する
3. 生成される音声の品質が中項目レベルでも適切である
4. API呼び出し回数の増加が許容範囲内である

## リスク・懸念事項

1. **API呼び出し回数の増加**: 中項目数が多い場合のレート制限とコスト
2. **LLM精度**: 中項目レベルの構造抽出精度
3. **スクリプト品質**: 短い中項目でも適切な講義になるか
4. **ファイル管理**: 音声ファイル数の大幅増加による管理複雑性

## テスト計画

### 結合テスト
- **テスト用PDF**: `test/test_for_middle_topic.pdf`
- **目的**: 中項目レベルでの音声生成が正常に動作することを確認
- **実行タイミング**: Phase 5（統合テスト・後方互換性確保）で実施

### テスト観点
1. 中項目の正確な抽出
2. 各中項目でのスクリプト生成品質
3. 音声ファイルの正常生成
4. ファイル命名規則の正確性
5. Manifestでの進捗管理

## 次のステップ

1. このPRDの内容についてユーザー確認・承認 ✅
2. Phase 1 から順次実装開始
3. 各Phaseでのテストとフィードバック収集
4. Phase 5 で `test/test_for_middle_topic.pdf` を使用した結合テスト実施