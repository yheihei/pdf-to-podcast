# PDFページ番号オフセット対応 - PRD

## 背景と問題定義

現在のPDFパーサーは、目次から取得した論理ページ番号（本の中のページ番号）をそのまま物理ページ番号（PDFファイル内の実際のページ番号）として扱っているため、前付け（序文、目次など）があるPDFでは、間違った内容を抽出してしまう。

### 具体例
- manifest.jsonで「8.1 コンポーネントの分類」が start_page: 101 となっている
- これは本の中での101ページ目を意味する（論理ページ番号）
- しかし実際のPDFファイルでは、前付けがあるため101ページ目は別の内容（適応度関数の話）が書かれている
- その結果、生成されたスクリプトが期待する内容とズレている

## 目的

PDFの論理ページ番号と物理ページ番号のオフセットを自動検出し、正しい内容を抽出できるようにする。

## 要件

### 機能要件

1. **ページ番号オフセットの自動検出**
   - PDFの最初の数ページから実際のページ番号表記を検出
   - 論理ページ番号と物理ページ番号の差分（オフセット）を計算
   - 例：物理10ページ目に「1」と表記されていれば、オフセットは9

2. **オフセットを考慮したテキスト抽出**
   - LLMから返される論理ページ番号にオフセットを加算して物理ページ番号に変換
   - 変換後の物理ページ番号でテキストを抽出

3. **フォールバック機能**
   - ページ番号が検出できない場合は、現在の動作（オフセット0）を維持
   - ユーザーが手動でオフセットを指定できるオプションを追加

### 非機能要件

1. **互換性**
   - 既存のAPIインターフェースは変更しない
   - 既存の処理フローを大幅に変更しない

2. **性能**
   - オフセット検出処理は最初の10-20ページのみを対象とし、高速化を図る

3. **ログ出力**
   - 検出されたオフセット値をログに出力
   - オフセット適用前後のページ番号をデバッグログに出力

## 技術設計

### 1. オフセット検出機能の実装

`PDFParser`クラスに以下のメソッドを追加：

```python
async def _detect_page_offset(self) -> int:
    """
    PDFの物理ページ番号と論理ページ番号のオフセットを検出
    
    Returns:
        オフセット値（物理ページ番号 = 論理ページ番号 + オフセット）
    """
```

実装方針：
- pdfminerを使用して最初の10-20ページのページ番号表記を探す
- 正規表現でページ番号パターン（数字のみ、囲まれた数字など）を検出
- 複数のページで一貫性のあるオフセットを確認

### 2. ページ番号変換機能

```python
def _convert_to_physical_page(self, logical_page: int) -> int:
    """
    論理ページ番号を物理ページ番号に変換
    """
    return logical_page + self.page_offset
```

### 3. 既存メソッドの修正

- `extract_chapters()` と `extract_sections()` で、LLMから返されたページ番号を物理ページ番号に変換
- `extract_text()` はそのまま（既に物理ページ番号を受け取っているため）

### 4. コマンドラインオプションの追加

```bash
python -m pdf_podcast --input file.pdf --page-offset 10
```

手動でオフセットを指定できるようにする。

## 実装手順

1. `_detect_page_offset()` メソッドの実装
2. PDFParserの初期化時にオフセット検出を実行
3. 既存のchapter/section抽出メソッドでオフセットを適用
4. テストケースの作成
5. ドキュメントの更新

## テスト計画

1. **単体テスト**
   - オフセット検出ロジックのテスト
   - ページ番号変換ロジックのテスト

2. **統合テスト**
   - 前付けがあるPDFでの動作確認
   - 前付けがないPDFでの動作確認（オフセット0）
   - 手動オフセット指定の動作確認

3. **回帰テスト**
   - 既存の全テストが通ることを確認

## リスクと対策

1. **ページ番号が検出できないPDF**
   - 対策：オフセット0で動作を継続（現在の動作と同じ）

2. **複雑なページ番号体系**
   - ローマ数字（i, ii, iii）と算用数字の混在
   - 対策：最初の算用数字ページを基準にする

3. **性能への影響**
   - 対策：オフセット検出は初回のみ実行、結果をキャッシュ

## 成功指標

- 前付けがあるPDFで正しい内容が抽出されること
- 既存のPDFでの動作に影響がないこと
- オフセット検出に失敗してもエラーにならないこと